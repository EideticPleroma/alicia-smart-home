# MQTT Bus Test Suite

Comprehensive test suite for the Alicia Smart Home AI Assistant MQTT Bus architecture, generated by the MCP QA Orchestrator.

## 🎯 Overview

This test suite provides comprehensive testing for all aspects of the MQTT Bus architecture:

- **Infrastructure Testing**: MQTT broker health, connectivity, and configuration
- **Service Discovery**: Service registration, health monitoring, and discovery
- **Message Routing**: Point-to-point and broadcast message delivery
- **Security**: Authentication, authorization, and encryption
- **Voice Pipeline**: Complete voice processing workflow
- **Device Integration**: Device control and status monitoring
- **Performance**: Load balancing, scaling, and throughput
- **Resilience**: Error recovery and fault tolerance
- **Monitoring**: Metrics collection and observability

## 📁 Test Structure

```
tests/
├── README.md                           # This file
├── requirements.txt                    # Test dependencies
├── conftest.py                        # Pytest configuration and fixtures
├── mqtt_bus_test_suite.feature        # BDD scenarios (Gherkin)
├── test_mqtt_bus_infrastructure.py    # Python test implementation
├── run_mqtt_tests.py                  # Test runner script
├── execute_mqtt_tests.py              # MCP-based test execution
├── quick_test.py                      # Quick validation script
└── results/                           # Test results and reports
    ├── test_report.html               # HTML test report
    ├── junit.xml                      # JUnit XML results
    └── coverage/                      # Coverage reports
```

## 🚀 Quick Start

### 1. Install Dependencies

```bash
pip install -r tests/requirements.txt
```

### 2. Run Quick Tests

```bash
python tests/quick_test.py
```

### 3. Run Full Test Suite

```bash
python tests/run_mqtt_tests.py --type all
```

### 4. Run Specific Test Types

```bash
# Critical tests only
python tests/run_mqtt_tests.py --type critical

# Infrastructure tests
python tests/run_mqtt_tests.py --type infrastructure

# Voice pipeline tests
python tests/run_mqtt_tests.py --type voice

# All test types
python tests/run_mqtt_tests.py --all
```

## 🧪 Test Types

### Critical Tests
- MQTT broker health check
- Service registration
- Point-to-point message delivery
- Service authentication
- Voice command processing
- Device control commands

### Infrastructure Tests
- MQTT broker connectivity
- TLS security configuration
- WebSocket support
- Docker Compose configuration
- Service wrapper pattern

### Discovery Tests
- Service registration process
- Health monitoring
- Service discovery queries
- Device registry functionality

### Messaging Tests
- Point-to-point delivery
- Broadcast messaging
- Message acknowledgments
- QoS levels
- Message routing

### Security Tests
- Service authentication
- Topic access control
- Message encryption
- ACL validation
- Certificate management

### Voice Pipeline Tests
- Voice command processing
- STT service integration
- AI service processing
- TTS service integration
- Error handling

### Device Integration Tests
- Device control commands
- Status monitoring
- Device registration
- Capability management

### Performance Tests
- Load distribution
- Service instance monitoring
- Message throughput
- Resource usage
- Scaling behavior

### Resilience Tests
- MQTT broker failure recovery
- Service failure recovery
- Network interruption handling
- Graceful degradation

### Monitoring Tests
- Metrics collection
- Health monitoring
- Alert generation
- Performance tracking

## 🔧 Configuration

### Test Configuration

The test suite uses pytest configuration in `conftest.py`:

```python
# MQTT broker configuration
mqtt_broker_config = {
    "host": "localhost",
    "port": 1883,
    "secure_port": 8883,
    "websocket_port": 9001,
    "username": "test_user",
    "password": "test_password"
}
```

### Environment Variables

Set these environment variables for testing:

```bash
export MQTT_BROKER_HOST=localhost
export MQTT_BROKER_PORT=1883
export MQTT_USERNAME=test_user
export MQTT_PASSWORD=test_password
```

## 📊 Test Reports

### HTML Report
```bash
python tests/run_mqtt_tests.py --type all --html-report
```
Generates: `tests/results/report.html`

### Coverage Report
```bash
python tests/run_mqtt_tests.py --type all --coverage
```
Generates: `tests/results/coverage/`

### JUnit XML
```bash
python tests/run_mqtt_tests.py --type all
```
Generates: `tests/results/junit.xml`

## 🎭 BDD Scenarios

The test suite includes comprehensive BDD scenarios in Gherkin format:

```gherkin
Feature: MQTT Bus Core Infrastructure
  As a system administrator
  I want to ensure the MQTT bus infrastructure is robust and reliable
  So that all services can communicate effectively

  @critical @infrastructure
  Scenario: MQTT Broker Health Check
    Given the MQTT broker is running on port 1883
    When I check the broker health status
    Then the broker should be healthy
    And the broker should accept connections
```

## 🔍 Test Fixtures

The test suite provides comprehensive fixtures:

- `mqtt_client`: MQTT test client
- `mock_mqtt_broker`: Mock MQTT broker
- `mock_security_gateway`: Mock security gateway
- `mock_device_registry`: Mock device registry
- `test_message_factory`: Message creation factory
- `test_voice_message_factory`: Voice message factory
- `test_device_message_factory`: Device message factory

## 🚨 Troubleshooting

### Common Issues

1. **MQTT Broker Not Running**
   ```bash
   # Start MQTT broker
   docker-compose -f infrastructure/docker/docker-compose.bus.yml up -d alicia-bus-core
   ```

2. **Missing Dependencies**
   ```bash
   pip install -r tests/requirements.txt
   ```

3. **Permission Issues**
   ```bash
   chmod +x tests/*.py
   ```

4. **Port Conflicts**
   ```bash
   # Check if ports are in use
   netstat -tulpn | grep :1883
   ```

### Debug Mode

Run tests with verbose output:

```bash
python tests/run_mqtt_tests.py --type all --verbose
```

### Test Logs

Check test execution logs:

```bash
tail -f tests/results/test_execution.log
```

## 📈 Continuous Integration

### GitHub Actions

```yaml
name: MQTT Bus Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.11
      - name: Install dependencies
        run: pip install -r tests/requirements.txt
      - name: Run tests
        run: python tests/run_mqtt_tests.py --type all
```

### Pre-commit Hooks

```bash
# Install pre-commit
pip install pre-commit

# Add to .pre-commit-config.yaml
repos:
  - repo: local
    hooks:
      - id: mqtt-tests
        name: MQTT Bus Tests
        entry: python tests/quick_test.py
        language: system
        pass_filenames: false
```

## 🎯 Quality Metrics

The test suite tracks several quality metrics:

- **Test Coverage**: Percentage of code covered by tests
- **Test Success Rate**: Percentage of tests passing
- **Performance Metrics**: Response times and throughput
- **Security Coverage**: Security test coverage
- **Error Recovery**: Resilience test results

## 📚 Additional Resources

- [Pytest Documentation](https://docs.pytest.org/)
- [Behave BDD Documentation](https://behave.readthedocs.io/)
- [MQTT Testing Best Practices](https://mqtt.org/)
- [Docker Testing Strategies](https://docs.docker.com/)

## 🤝 Contributing

To add new tests:

1. Add BDD scenarios to `mqtt_bus_test_suite.feature`
2. Implement Python tests in `test_mqtt_bus_infrastructure.py`
3. Add fixtures to `conftest.py` if needed
4. Update this README with new test information

## 📄 License

This test suite is part of the Alicia Smart Home AI Assistant project and follows the same licensing terms.

---

**Generated by MCP QA Orchestrator**  
**Author: Cline MCP Implementation**  
**Version: 1.0.0**




